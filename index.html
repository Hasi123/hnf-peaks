<!doctype html>
<html>
    <head>
        <meta charset="utf-8"/>
        <title>Hike & Fly Peaks Switzerland</title>

        <script src='https://api.mapbox.com/mapbox-gl-js/v1.11.1/mapbox-gl.js'></script>
        <link href='https://api.mapbox.com/mapbox-gl-js/v1.11.1/mapbox-gl.css' rel='stylesheet' />

        <style type="text/css">
            html {
                font-family: sans-serif;
                font-size: 0.8em;
            }
            th {
                text-align: left;
            }
            #wrapper {
                width: 100%;
            }
            #map {
                height: 600px;
                width: 100%;
            }
            .mapboxgl-popup-content h3 {
                margin-top: 4px;
                margin-bottom: 8px;
            }
            .mapboxgl-popup-content p {
                margin-top: 0px;
                margin-bottom: 8px;
            }
        </style>
    </head>
    <body>
        <div id="header">
            <h1>Hike & Fly Peaks Switzerland</h1>
            <p>Included are peaks with an elevation over 1000 m and launches within 300 m from the peak. Transparent markers mean that no launches were found from that location.</p>
            <p>Colors: <span style="color: blue;">&#9679;</span> No launches | <span style="color: orange;">&#9679;</span> 1&ndash;3 launches | <span style="color: red;">&#9679;</span> &gt;3 launches</p>
        </div>

        <div id="wrapper">
            <div id="map"></div>
        </div>

        <footer>
            <p>Kontakt: <a href="mailto:mail@dbrgn.ch">mail@dbrgn.ch</a> | <a href="https://github.com/dbrgn/hnf-peaks">Github</a></p>
        </footer>

        <script>
            mapboxgl.accessToken = 'pk.eyJ1IjoiZGFuaWxvIiwiYSI6IkM2cVZZdkkifQ.KK_4WqiWBL_DhpjIfGPcLw';

            const map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/danilo/citrnqoyx000h2jmg5qenf8ep',
                center: [8.496828420038582, 46.76733810404278],
                zoom: 8,
            });

            map.on('load', () => {
                console.info('map loaded');

                map.addSource('peaks', {
                    type: 'geojson',
                    //data: 'https://raw.githubusercontent.com/dbrgn/hnf-peaks/main/geojson-2020-08-03.json',
                    data: 'geojson-2020-08-03.json',
                });

                map.addLayer({
                    id: 'markers',
                    source: 'peaks',
                    type: 'circle',
                    paint: {
                        // Set the label content to the
                        // feature's `name` property
                        //'text-field': ['get', 'title'],
                        'circle-radius': [
                            'interpolate', ['linear'], ['zoom'],
                            10, 3,
                            14, 18,
                        ],
                        'circle-color': [
                            'match',
                            ['get', 'flights'],
                            0, 'blue',
                            1, 'orange',
                            2, 'orange',
                            3, 'orange',
                            /* other */ 'red',
                        ],
                    },
                });

                // Show popup on click
                map.on('click', 'markers', (e) => {
                    const coordinates = e.features[0].geometry.coordinates.slice();
                    const description = getDescription(e.features[0]);
                    new mapboxgl.Popup()
                        .setLngLat(coordinates)
                        .setHTML(description)
                        .addTo(map);
                });

                // Change the cursor to a pointer when the mouse is over the places layer
                map.on('mouseenter', 'markers', function() {
                    map.getCanvas().style.cursor = 'pointer';
                });

                // Change it back to a pointer when it leaves
                map.on('mouseleave', 'markers', function() {
                    map.getCanvas().style.cursor = '';
                });
            });

            // Function to create description from GeoJSON feature
            function getDescription(feature) {
                console.log(feature);
                const p = feature.properties;
                let description = '<h3>' + p.title + '</h3>';
                description += '<strong>Elevation</strong><p>' + p.ele + ' m</p>';
                description += '<strong>Flights</strong><p>' + p.flights + '</p>';
                const topFlight = JSON.parse(p['top']);
                if (topFlight['pilot'].length > 0) {
                    description += '<strong>Record holder</strong><p>' + topFlight.pilot + ' (' + topFlight.dist + ')</p>';
                }
                return description;
            };
        </script>

    </body>
</html>
